# Constitute Gateway

Native gateway service for Constitute. This repo provides the native dependency layer that browser clients rely on for bootstrap discovery, gateway relay, and swarm-facing transport primitives.

## Scope
- Discovery bootstrap over Nostr-compatible relays
- Zone-scoped peer discovery and record propagation
- Local gateway relay for browser peers (WS/WSS)
- Native UDP transport primitives used to build DHT behavior

Out of scope in this repo:
- Application-level messaging UX
- Community policy/ACL UX
- Browser client UI logic (lives in `constitute` web repo)

## Current Status
- Active development branch: `initial-sprint`
- Discovery schema alignment with web repo: in progress
- Gateway relay + request/response record flow: implemented
- UDP targeted request forwarding (fanout + hop limits): implemented

## Architecture
- System architecture and roadmap: `ARCHITECTURE.md`
- Web reference implementation: `https://github.com/Aux0x7F/constitute`

## Documentation
- Documentation index: `docs/README.md`
- Protocol reference: `docs/PROTOCOL.md`
- Operations guide: `docs/OPERATIONS.md`
- Development workflow: `docs/DEVELOPMENT.md`
- Rust API docs: generated by `.github/workflows/docs.yml`
  - On `main`, docs can be published via GitHub Pages.

## Repository Layout
- `src/main.rs`: service startup, config loading, orchestration
- `src/discovery.rs`: discovery envelopes, zone presence publication
- `src/local_relay.rs`: local Nostr-compatible relay service
- `src/transport.rs`: UDP transport, peer handshake, request fanout/forwarding
- `src/swarm_store.rs`: identity/device record validation and storage
- `src/nostr.rs`: NIP-01 signing and event verification helpers
- `src/keystore.rs`: encrypted key storage abstraction
- `tests/smoke.rs`: integration-style behavior tests
- `scripts/`: build/install/hardening automation

## Discovery and Record Semantics
### Discovery record
- Kind: `30078`
- Required tags: `['t','swarm_discovery']`, `['type','device']`
- Record payload includes device identity and role metadata

### Zone presence
- Kind: `1`
- Required tags: `['t','constitute']`, `['z','<zone_key>']`
- Payload type: `zone_presence`

### Gateway app-channel request/response
Incoming app event (`kind=1`, tag `t=constitute`):
- `type = swarm_record_request`
- Optional: `requestId`, `timeoutMs`, `zone`
- Optional targeted lookup fields: `identityId`, `devicePk`

Gateway responses:
- `swarm_identity_record`
- `swarm_device_record`
- `swarm_record_response` with `status = pending|complete|timeout`

## Build and Test
### Build
```bash
cargo build --features platform-linux
cargo build --features platform-windows
```

### Test
```bash
cargo test --features platform-windows -j 1
cargo test --features platform-linux -j 1
```

## Configuration
- Template: `config.example.json`
- Runtime file: `config.json` (gitignored)
- Sensitive fields are stored in encrypted keystore state under `data_dir`

Selected transport settings:
- `udp_request_fanout` (default: `8`)
- `udp_request_max_hops` (default: `2`)
- `udp_handshake_interval_secs`
- `udp_peer_timeout_secs`

Selected relay settings:
- `relay_rate_limit_per_sec`
- `relay_max_frame_bytes`
- `relay_replay_window_secs`
- `relay_replay_skew_secs`

## Security Model (Operational)
- Discovery channels are treated as observable metadata planes
- Identity/application confidentiality is expected at higher cryptographic layers
- Zone membership metadata may be linkable; operator OPSEC is still required
- High-risk deployments should use VPN/tunnel controls and hardened host posture

## Host Hardening
Automation in this repo:
- `scripts/harden-host.sh`
- `scripts/install-systemd-override.sh`

Typical usage:
- Audit host posture
- Apply bounded firewall rules for explicit gateway ports
- Install service CPU quota override (`CPUQuota=85%`)

## Packaging and Install
### Ubuntu Core / Snap
```bash
make snap
```

### Windows service (from clone)
```powershell
powershell -ExecutionPolicy Bypass -File .\scripts\install-service.ps1 -ServiceName ConstituteGateway -NssmPath .\nssm\nssm.exe
```

## Contributing
Contributor workflow, branch hygiene, and coding conventions are documented in `CONTRIBUTING.md`.

## Roadmap (Short)
- Harden relay signaling envelope parity with web repo
- Expand DHT behavior from targeted request forwarding to fuller keyspace routing
- Complete web-gateway convergence for browser transport fallback
- Finalize Ubuntu Core validation and CI parity
