#!/usr/bin/env bash
set -euo pipefail

CONF="/var/snap/constitute-gateway/common/config.json"

log() { echo "[configure] $*"; }

log "configure hook running"

if [ -f "$CONF" ]; then
  if command -v python3 >/dev/null 2>&1; then
    python3 - <<'PY'
import json
from pathlib import Path
p = Path("/var/snap/constitute-gateway/common/config.json")
try:
    data = json.loads(p.read_text())
except Exception as e:
    print(f"[configure] failed to read config: {e}")
    raise SystemExit(0)

def get(key, default=""):
    return data.get(key, default)

def parse_port(value):
    if not value or not isinstance(value, str):
        return None
    if ':' not in value:
        return None
    try:
        port = int(value.rsplit(':', 1)[1])
    except Exception:
        return None
    if port < 1 or port > 65535:
        return None
    return port

bind = get("bind", "")
relay_bind = get("relay_bind", "")
relay_bind_tls = get("relay_bind_tls", "")

print("[configure] bind:", bind)
print("[configure] relay_bind:", relay_bind)
print("[configure] relay_bind_tls:", relay_bind_tls)
print("[configure] udp_peers:", len(get("udp_peers", []) or []))
print("[configure] nostr_relays:", len(get("nostr_relays", []) or []))

if not bind:
    print("[configure] WARN: bind is empty")
if bind and parse_port(bind) is None:
    print("[configure] WARN: bind port invalid")
if relay_bind and parse_port(relay_bind) is None:
    print("[configure] WARN: relay_bind port invalid")
if relay_bind_tls and parse_port(relay_bind_tls) is None:
    print("[configure] WARN: relay_bind_tls port invalid")

nostr_relays = get("nostr_relays", []) or []
if not nostr_relays:
    print("[configure] WARN: nostr_relays empty (discovery disabled)")

udp_max = get("udp_max_packet_bytes", 2048)
try:
    udp_max = int(udp_max)
    if udp_max < 256 or udp_max > 65507:
        print("[configure] WARN: udp_max_packet_bytes out of safe range (256-65507)")
except Exception:
    print("[configure] WARN: udp_max_packet_bytes invalid")

rate = get("udp_rate_limit_per_sec", 60)
try:
    rate = int(rate)
    if rate < 1:
        print("[configure] WARN: udp_rate_limit_per_sec disabled/low")
except Exception:
    print("[configure] WARN: udp_rate_limit_per_sec invalid")
PY
  else
    log "python3 not available; showing raw port fields"
    grep -E '"bind"|"relay_bind"|"relay_bind_tls"' "$CONF" || true
  fi
else
  log "config.json not found (first boot expected)"
fi

exit 0
